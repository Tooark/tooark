# Release Notes v3.0.0

Data de lançamento: 09/01/2026

## ⚠️ Breaking Changes

Esta é uma versão major com mudanças significativas que podem impactar projetos existentes.

### Tooark.Entities - Comportamento de Validação Aprimorado

As entidades agora lançam exceções `BadRequestException` quando validações falham, em vez de apenas adicionar notificações.

#### Mudanças em `SoftDeletableEntity`

| Método Anterior              | Método Novo          | Descrição                                                   |
| ---------------------------- | -------------------- | ----------------------------------------------------------- |
| `ChangeNotAllowedIsDeleted`  | `ValidateNotDeleted` | Renomeado para melhor semântica                             |
| —                            | `EnsureNotDeleted`   | Novo método que lança `BadRequestException` se deletado     |
| `SetDeleted`                 | `SetDeleted`         | Agora lança `BadRequestException` em caso de erro           |
| `SetRestored`                | `SetRestored`        | Agora lança `BadRequestException` em caso de erro           |

#### Mudanças em `VersionedEntity`

- O método `SetUpdatedBy` foi simplificado, delegando validação para a classe base
- A versão agora é incrementada apenas após atualização bem-sucedida

#### Mudanças em `InitialEntity` / `DetailedEntity`

- `SetCreatedBy` agora lança `BadRequestException` em caso de erro de validação
- `SetUpdatedBy` agora lança `BadRequestException` em caso de erro de validação
- Mensagem de erro alterada de `ChangeNotAllowed;CreatedBy` para `ChangeBlocked;CreatedBy`

#### Mudanças em `BaseEntity`

- `SetId` agora é protegido e só pode ser chamado uma vez
- Construtor que aceita `Guid` adicionado
- Mensagem de erro alterada de `IdentifierEmpty;Id` para `Empty;Id` e novo código `T.ENT.BAS2`

#### Nova Dependência

```xml
<ProjectReference Include="..\Tooark.Exceptions\Tooark.Exceptions.csproj" />
```

### Tooark.Extensions - Remoção de Método

| Método Removido      | Alternativa     |
| -------------------- | --------------- |
| `ToNormalizeRegex()` | `ToNormalize()` |

### Tooark.Utils - Remoção de Método

| Método Removido           | Alternativa         |
| ------------------------- | ------------------- |
| `Normalize.ValueRegex()`  | `Normalize.Value()` |

---

## Mudanças Principais

### Tooark.Entities - Validações com Exceções

Os métodos de entidades agora lançam `BadRequestException` quando validações falham:

```csharp
// Antes (v2.x)
entity.SetDeleted(userId);
if (!entity.IsValid)
{
    // Tratar erro manualmente
}

// Agora (v3.0)
try
{
    entity.SetDeleted(userId);
}
catch (BadRequestException ex)
{
    // Exceção já contém as notificações
}
```

### Tooark.Extensions - Melhorias no `ToSlug`

O método `ToSlug` foi completamente reescrito para suportar transliteração de caracteres especiais:

| Caractere | Transliteração |
| --------- | -------------- |
| `&`       | `and`          |
| `@`       | `at`           |
| `$`       | `dollar`       |
| `€`       | `euro`         |
| `£`       | `pound`        |
| `¥`       | `yen`          |
| `©`       | `c`            |
| `®`       | `r`            |
| `™`       | `tm`           |
| `ß`       | `ss`           |
| `æ`       | `ae`           |
| `œ`       | `oe`           |
| `ø/Ø`     | `o`            |
| `đ/Ð/ð`   | `d`            |
| `ł/Ł`     | `l`            |
| `þ`       | `th`           |

**Exemplo:**

```csharp
"Rock & Roll".ToSlug();     // "rock-and-roll"
"Olá Mundo!!!".ToSlug();    // "ola-mundo"
"C# & C++".ToSlug();        // "c-and-c"
```

### Tooark.Utils - Melhorias no `Normalize`

O método `Normalize.Value` agora usa decomposição Unicode (FormD) e suporta transliteração de caracteres especiais:

| Caractere | Transliteração |
| --------- | -------------- |
| `&`       | `AND`          |
| `@`       | `AT`           |
| `$`       | `DOLLAR`       |
| `€`       | `EURO`         |
| `£`       | `POUND`        |
| `¥`       | `YEN`          |
| `©`       | `C`            |
| `®`       | `R`            |
| `™`       | `TM`           |
| `ß`       | `SS`           |
| `æ`       | `AE`           |
| `œ`       | `OE`           |
| `ø/Ø`     | `O`            |
| `đ/Ð/ð`   | `D`            |
| `ł/Ł`     | `L`            |
| `þ`       | `TH`           |

### Tooark.Securities - Melhoria no Tratamento de Erros

Substituição de exceções genéricas por exceções específicas do Tooark:

| Exceção Anterior       | Nova Exceção                | Cenário                           |
| ---------------------- | --------------------------- | --------------------------------- |
| `ArgumentNullException`| `InternalServerErrorException` | Options não configurado        |
| `ArgumentException`    | `InternalServerErrorException` | Configuração inválida          |
| `ArgumentException`    | `BadRequestException`       | Dados de entrada inválidos        |

#### CryptographyService

```csharp
// Antes
throw new ArgumentException("Cryptography.SecretNotConfigured");

// Agora
throw new InternalServerErrorException("Options.Cryptography.SecretNotConfigured");
```

#### JwtTokenService

- Adicionado `ILogger<JwtTokenService>` para logging de erros
- Mensagens de erro mais específicas e descritivas
- Logging de erros criptográficos para facilitar diagnóstico

```csharp
// Construtor atualizado
public JwtTokenService(IOptions<JwtOptions> jwtOptions, ILogger<JwtTokenService> logger)
```

#### Nova Dependência

```xml
<ProjectReference Include="..\Tooark.Exceptions\Tooark.Exceptions.csproj" />
```

---

## Testes Atualizados

### Tooark.Tests/Entities

Todos os testes de entidades foram atualizados para validar o novo comportamento de exceções:

| Arquivo                        | Mudanças                                                |
| ------------------------------ | ------------------------------------------------------- |
| `AuditableEntityTests.cs`      | Testes para `BadRequestException` e novos métodos       |
| `BaseEntityTests.cs`           | Testes para construtor com `Guid` e `SetId` protegido   |
| `DetailedEntityTests.cs`       | Testes para exceções em `SetCreatedBy`/`SetUpdatedBy`   |
| `FileEntityTests.cs`           | Testes para `BadRequestException` em validações         |
| `InitialEntityTests.cs`        | Testes para exceções em `SetCreatedBy`                  |
| `SoftDeletableEntityTests.cs`  | Testes para `ValidateNotDeleted` e `EnsureNotDeleted`   |
| `VersionedEntityTests.cs`      | Testes para exceções em `SetUpdatedBy`                  |

### Tooark.Tests/Extensions

| Arquivo                    | Mudanças                                               |
| -------------------------- | ------------------------------------------------------ |
| `StringExtensionsTests.cs` | Remoção de testes `ToNormalizeRegex`, novos testes `ToSlug` |

### Tooark.Tests/Utils

| Arquivo              | Mudanças                                        |
| -------------------- | ----------------------------------------------- |
| `NormalizedTests.cs` | Remoção de testes `ValueRegex`, valores atualizados |

---

## Migração

### Passo 1: Atualizar tratamento de exceções

```csharp
// Antes
entity.SetCreatedBy(userId);
if (!entity.IsValid)
{
    return BadRequest(entity.Notifications);
}

// Depois
try
{
    entity.SetCreatedBy(userId);
}
catch (BadRequestException ex)
{
    return BadRequest(ex.GetErrorMessages());
}
```

### Passo 2: Atualizar chamadas de métodos renomeados

```csharp
// Antes
entity.ChangeNotAllowedIsDeleted();

// Depois
entity.ValidateNotDeleted();
// ou para lançar exceção:
entity.EnsureNotDeleted();
```

### Passo 3: Remover uso de métodos removidos

```csharp
// Antes
var normalized = value.ToNormalizeRegex();

// Depois
var normalized = value.ToNormalize();
```

---

## Impacto

- **Breaking changes** - Entidades agora lançam exceções em vez de apenas adicionar notificações
- **Métodos removidos** - `ToNormalizeRegex()` e `Normalize.ValueRegex()` foram removidos
- **Métodos renomeados** - `ChangeNotAllowedIsDeleted` → `ValidateNotDeleted`
- **Nova dependência** - `Tooark.Entities` e `Tooark.Securities` agora dependem de `Tooark.Exceptions`

---

## Informações Adicionais

- Tag relacionado: `v3.0.0`
- Data de lançamento: **2026-01-09**
